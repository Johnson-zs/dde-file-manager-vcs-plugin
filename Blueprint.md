# DDE文件管理器Git版本控制插件 - 项目蓝图

## 1. 项目概述

### 1.1 核心目标
基于 `dfm-extension` 框架开发一个功能强大的Git版本控制插件，为深度桌面环境（DDE）的文件管理器提供完整的Git集成功能。目标是创建一个媲美 TortoiseGit、RabbitVCS、Dolphin Git插件 的专业级工具，提供直观美观的界面和完整的Git工作流支持。

### 1.2 设计理念
- **GitKraken启发的UX设计**：参考GitKraken的界面设计原则，强调可视化、直观性和高效性
- **Linux原生体验**：深度集成DDE环境，提供符合Linux用户习惯的操作体验
- **智能自动化**：减少用户手动操作，智能感知文件状态和仓库变化
- **多层次可扩展**：从基础功能到高级特性的渐进式功能体系

### 1.3 核心价值主张
- **零学习成本**：Git操作完全图形化，降低技术门槛
- **实时状态可视化**：文件状态一目了然，提高工作效率
- **工作流完整性**：从文件修改到提交推送的完整生命周期支持
- **团队协作优化**：支持多人协作的现代Git工作流

## 2. 系统架构设计

### 2.1 核心架构
```
DDE文件管理器
    ↓ (通过dfm-extension接口)
Git插件核心 (dfm-extension-git.cpp)
    ├── GitEmblemIconPlugin    (角标系统)
    ├── GitMenuPlugin          (右键菜单系统)
    ├── GitWindowPlugin        (窗口监控系统)
    └── GitDialogs            (UI交互系统)
        ├── GitLogDialog      (提交历史查看器)
        ├── GitCommitDialog   (提交对话框)
        ├── GitCheckoutDialog (分支切换对话框)
        ├── GitMergeDialog    (合并对话框)
        ├── GitStashDialog    (暂存对话框)
        └── GitConfigDialog   (配置对话框)
```

### 2.2 数据流架构
```
Git仓库状态监控
    ↓
Global::Cache (状态缓存)
    ↓
GitVersionController (状态控制器)
    ↓
UI组件更新 (角标、菜单、对话框)
    ↓
用户交互反馈
```

### 2.3 模块职责划分

#### 2.3.1 状态管理模块
- **Global::Cache**: 线程安全的Git状态缓存系统
- **GitVersionController**: 后台Git状态监控和更新控制器
- **GitVersionWorker**: 异步Git状态检索工作线程

#### 2.3.2 UI插件模块
- **GitEmblemIconPlugin**: 文件状态角标显示
- **GitMenuPlugin**: 上下文菜单集成
- **GitWindowPlugin**: 窗口事件监听和状态同步

#### 2.3.3 交互界面模块
- **GitDialogs**: 各种Git操作的图形界面
- **Utils**: Git命令执行和状态解析工具集

## 3. 功能模块设计

### 3.1 文件状态角标系统

#### 3.1.1 状态类型定义
```cpp
enum class ItemVersion {
    UnversionedVersion,              // 未版本控制 (无角标)
    NormalVersion,                   // 正常版本 🟢
    UpdateRequiredVersion,           // 需要更新 🔵  
    LocallyModifiedVersion,          // 本地修改(已暂存) 🟡
    LocallyModifiedUnstagedVersion,  // 本地修改(未暂存) 🟠
    AddedVersion,                    // 新增文件 ➕
    RemovedVersion,                  // 已删除 ➖
    ConflictingVersion,              // 冲突文件 ⚠️
    IgnoredVersion,                  // 忽略文件 (无角标)
    MissingVersion                   // 缺失文件 ❓
};
```

#### 3.1.2 角标显示策略
- **文件级别**：直接显示文件状态对应的角标
- **目录级别**：显示目录内最重要的状态（冲突 > 修改 > 新增 > 正常）
- **性能优化**：使用缓存机制避免重复的Git命令调用

### 3.2 右键菜单集成系统

#### 3.2.1 上下文感知菜单
**单文件选择菜单**：
- Git Add (适用于：未版本控制、本地修改未暂存的文件)
- Git Remove (适用于：已版本控制的文件)
- Git Revert (适用于：有本地修改或冲突的文件)
- Git Log... (适用于：已在版本控制中的文件)
- Git Blame... (适用于：已在版本控制中的文件)
- Git Diff... (适用于：有修改的文件)

**多文件选择菜单**：
- Git Add Selected (批量添加)
- Git Remove Selected (批量移除)
- Git Revert Selected (批量还原)

**空白区域菜单**：
- Git Log... (仓库提交历史)
- Git Status... (仓库状态概览)
- Git Checkout... (分支切换)
- Git Pull... (拉取更新)
- Git Push... (推送提交)
- Git Commit... (提交更改)
- Git Stash... (暂存管理)
- Git Merge... (分支合并)
- Git Config... (仓库配置)

#### 3.2.2 智能菜单项状态
- 根据文件Git状态动态启用/禁用菜单项
- 提供工具提示说明操作适用条件
- 支持菜单项图标状态指示

### 3.3 Git Log 查看器 (GitKraken风格)

#### 3.3.1 三栏布局设计
```
┌─────────────────────────────────────────────────────────┐
│ [工具栏: 分支选择|搜索|刷新|设置]                      │
├─────────────────┬───────────────────────────────────────┤
│                 │ 提交详情区域                          │
│                 │ ┌─────────────────────────────────────┐ │
│    提交列表     │ │ 提交哈希: abc123...                 │ │
│  (图形化分支)   │ │ 作者: John Doe                      │ │
│ ┌─────────────┐ │ │ 日期: 2024-01-01                    │ │
│ │ ● feat: add │ │ │ 消息: 添加新功能                    │ │
│ │ │ └─ fix:  │ │ │                                     │ │
│ │ │   └─ doc │ │ └─────────────────────────────────────┘ │
│ │ ●───────── │ │                                         │
│ └─────────────┘ │ 文件差异区域                          │
│                 │ ┌─────────────────────────────────────┐ │
│                 │ │ +++ src/main.cpp                    │ │
│                 │ │ --- src/main.cpp                    │ │
│                 │ │ @@ -10,3 +10,5 @@                   │ │
│                 │ │ + 新增代码行                        │ │
│                 │ │ - 删除代码行                        │ │
│                 │ └─────────────────────────────────────┘ │
└─────────────────┴───────────────────────────────────────┘
```

#### 3.3.2 核心特性
- **智能分页加载**：自动检测滚动到底部，无缝加载更多提交记录
- **图形化分支视图**：使用ASCII艺术或自定义绘制显示分支关系
- **实时搜索过滤**：支持按提交消息、作者、哈希搜索
- **多种视图模式**：简洁模式、详细模式、图形模式切换
- **语法高亮差异**：使用QSyntaxHighlighter提供代码差异高亮

#### 3.3.3 性能优化
- **虚拟滚动**：对于大型仓库，使用虚拟列表技术
- **后台加载**：Git命令在工作线程执行，避免UI冻结
- **增量更新**：只重新加载变化的部分

### 3.4 Git提交对话框

#### 3.4.1 智能提交界面
```
┌─────────────────────────────────────────────────────────┐
│ Git Commit                                           × │
├─────────────────────────────────────────────────────────┤
│ 提交消息                                               │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ feat: 添加新功能                                    │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │                                                     │ │
│ │ 详细描述...                                         │ │
│ │                                                     │ │
│ └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│ 暂存区文件 (3)                           [全选][反选] │
│ ☑ src/main.cpp                      [M] 12行修改      │
│ ☑ src/utils.h                       [A] 新文件        │
│ ☑ docs/README.md                    [M] 5行修改       │
├─────────────────────────────────────────────────────────┤
│ 工作区文件 (2)                           [全选][反选] │
│ ☐ test/test.cpp                     [M] 8行修改       │
│ ☐ config/app.conf                   [?] 未跟踪        │
├─────────────────────────────────────────────────────────┤
│                     [取消]  [提交]  [提交并推送]      │
└─────────────────────────────────────────────────────────┘
```

#### 3.4.2 高级特性
- **提交消息模板**：支持自定义提交消息模板
- **Conventional Commits**：支持约定式提交规范验证
- **文件差异预览**：点击文件显示差异预览
- **智能文件分组**：按修改类型、目录自动分组文件

### 3.5 Git分支管理

#### 3.5.1 分支切换对话框
```
┌─────────────────────────────────────────────────────────┐
│ Git Checkout                                         × │
├─────────────────────────────────────────────────────────┤
│ [本地分支] [远程分支] [标签] [提交哈希]                │
├─────────────────────────────────────────────────────────┤
│ ● main                    [当前分支]   2小时前更新     │
│   feature/login           [2提交领先]  1天前更新       │
│   bugfix/memory-leak      [已合并]     3天前更新       │
│   origin/develop          [远程分支]   5小时前更新     │
├─────────────────────────────────────────────────────────┤
│ 新建分支: ┌──────────────────────────────────────────┐ │
│          │ feature/new-feature                      │ │
│          └──────────────────────────────────────────┘ │
│ □ 创建后立即推送到远程                                 │
├─────────────────────────────────────────────────────────┤
│                         [取消]  [切换/创建]           │
└─────────────────────────────────────────────────────────┘
```

#### 3.5.2 分支可视化
- **分支关系图**：显示分支之间的合并关系
- **提交统计**：显示各分支的提交数量和时间
- **状态指示**：当前分支、已合并分支、远程分支状态

### 3.6 高级Git操作界面

#### 3.6.1 Git Status增强对话框
```
┌─────────────────────────────────────────────────────────┐
│ Git Status                                           × │
├─────────────────────────────────────────────────────────┤
│ 工作区文件 (3)                           [全选][反选] │
│ ☐ src/main.cpp                     [M] 12行修改       │
│ ☐ src/utils.h                      [A] 新文件         │
│ ☐ docs/README.md                   [M] 5行修改        │
├─────────────────────────────────────────────────────────┤
│ 暂存区文件 (2)                           [全选][反选] │
│ ☑ test/test.cpp                    [M] 8行修改        │
│ ☑ config/app.conf                  [?] 未跟踪         │
├─────────────────────────────────────────────────────────┤
│ 文件差异预览                                           │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ +++ src/main.cpp                                    │ │
│ │ @@ -10,3 +10,5 @@                                   │ │
│ │ + 新增代码行                                        │ │
│ │ - 删除代码行                                        │ │
│ └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│           [刷新]  [暂存选中]  [提交]  [关闭]           │
└─────────────────────────────────────────────────────────┘
```

**核心功能**：
- **保持现有布局基础**：在原有的工作区/暂存区文件列表基础上增强
- **文件右键菜单**：支持Git Add、Remove、Revert等操作
- **多选批量操作**：支持Ctrl+Click和Shift+Click多选文件
- **实时差异预览**：选中文件时在底部显示差异内容
- **快捷操作按钮**：提供常用操作的快捷按钮

#### 3.6.2 Git Blame内联查看器
```
┌─────────────────────────────────────────────────────────┐
│ Git Blame - src/main.cpp                             × │
├─────────────────────────────────────────────────────────┤
│ 行号 │ 作者      │ 时间      │ 哈希    │ 代码内容      │
├─────────────────────────────────────────────────────────┤
│   1  │ John Doe  │ 2024-01-01│ abc123  │ #include <Qt> │
│   2  │ Jane S.   │ 2024-01-02│ def456  │ int main() {  │
│   3  │ John Doe  │ 2024-01-01│ abc123  │   return 0;   │
│   4  │ Bob Chen  │ 2024-01-03│ ghi789  │ }             │
└─────────────────────────────────────────────────────────┘
```

**交互特性**：
- **内联显示**：代码行与blame信息在同一行显示
- **颜色编码**：不同作者使用不同背景色区分
- **悬浮详情**：鼠标悬浮显示完整提交信息
- **点击跳转**：点击提交哈希显示提交详情对话框

#### 3.6.3 Git Commit实用化对话框
```
┌─────────────────────────────────────────────────────────┐
│ Git Commit                                           × │
├─────────────────────────────────────────────────────────┤
│ □ Amend last commit    □ Allow empty commit             │
├─────────────────────────────────────────────────────────┤
│ 提交消息                                               │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ feat: 添加新功能                                    │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │ 详细描述...                                         │ │
│ └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│ 暂存区文件 (3)                           [全选][反选] │
│ ☑ src/main.cpp                      [M] 修改          │
│ ☑ src/utils.h                       [A] 新增          │
│ ☑ docs/README.md                    [M] 修改          │
├─────────────────────────────────────────────────────────┤
│                     [取消]  [提交]  [提交并推送]      │
└─────────────────────────────────────────────────────────┘
```

**实用功能**：
- **Amend模式**：支持修改最后一次提交
- **Allow Empty**：支持空提交（用于触发CI等场景）
- **简单直观**：避免过度复杂的提交模式
- **基本验证**：提交消息的基本格式检查

## 4. 技术实现方案

### 4.1 框架和技术栈

#### 4.1.1 核心技术
- **开发框架**: dfm-extension (深度文件管理器扩展框架)
- **UI框架**: Qt6 Widgets (专注于成熟稳定的Widget技术)
- **编程语言**: C++17
- **构建系统**: CMake 3.14+
- **版本控制集成**: Git命令行工具

#### 4.1.2 第三方依赖
- **Qt6模块**: Core, Widgets, Gui, Core5Compat
- **语法高亮**: QSyntaxHighlighter + 自定义语法规则
- **图标资源**: 系统主题图标 + 自定义SVG图标

### 4.2 实现约束和原则

#### 4.2.1 技术选择原则
- **Widget优先**：优先使用Qt Widgets，避免过度技术化
- **渐进增强**：在现有功能基础上渐进式改进
- **实用导向**：专注于文件管理器场景的实用功能
- **简单可靠**：避免过度设计和复杂架构

#### 4.2.2 功能边界
- **非目标功能**：不实现IDE级别的高级Git功能
- **核心定位**：文件管理器的Git辅助工具
- **用户群体**：普通用户和轻度开发者
- **集成限制**：与DDE文件管理器的深度集成

### 4.3 性能优化策略

#### 4.3.1 多线程架构
```cpp
class GitVersionController : public QObject {
    // 主线程：UI更新和用户交互
    // 工作线程：Git命令执行和状态检索
    QThread m_workerThread;
    GitVersionWorker *m_worker;
};
```

#### 4.3.2 缓存机制
- **状态缓存**: 减少重复的Git状态查询
- **图标缓存**: 缓存渲染好的状态图标
- **差异缓存**: 缓存文件差异计算结果

#### 4.3.3 增量更新
- **文件系统监控**: 使用QFileSystemWatcher监控文件变化
- **Git钩子集成**: 利用Git钩子实现状态自动更新
- **智能刷新策略**: 只刷新确实发生变化的部分

### 4.4 错误处理和稳定性

#### 4.4.1 异常处理策略
```cpp
class GitCommand {
public:
    enum class Result { Success, Timeout, CommandError, ParseError };
    
    Result execute(const QStringList &args, QString &output, QString &error);
    bool isRepositoryValid(const QString &path);
    void handleGitError(const QString &error);
};
```

#### 4.4.2 降级策略
- **命令失败处理**: Git命令失败时的友好错误提示
- **仓库损坏处理**: 检测并处理损坏的Git仓库
- **权限问题处理**: 处理文件权限不足的情况

### 4.5 国际化和本地化

#### 4.5.1 多语言支持
- **Qt国际化框架**: 使用QTranslator和tr()函数
- **支持语言**: 中文简体、英文、其他主要语言
- **动态语言切换**: 支持运行时切换界面语言

#### 4.5.2 文化适配
- **日期时间格式**: 适配不同地区的日期时间显示
- **快捷键适配**: 适配不同输入法的快捷键冲突

## 5. 用户体验设计

### 5.1 设计原则

#### 5.1.1 GitKraken启发的UX原则
- **可视化优先**: 复杂的Git概念通过可视化元素呈现
- **操作可预见**: 用户能够预见操作的结果
- **即时反馈**: 每个操作都有明确的状态反馈
- **错误宽容**: 提供撤销和恢复机制

#### 5.1.2 Linux桌面环境集成
- **DDE主题一致性**: 遵循DDE的视觉设计语言
- **键盘导航**: 完整的键盘导航支持
- **无障碍访问**: 支持屏幕阅读器和高对比度模式

### 5.2 界面设计标准

#### 5.2.1 视觉层次
- **主要操作**: 使用强调色和大尺寸按钮
- **次要操作**: 使用次要颜色和中等尺寸
- **危险操作**: 使用警告色和确认对话框

#### 5.2.2 交互反馈
- **鼠标悬停**: 所有可交互元素的悬停效果
- **点击反馈**: 按钮点击的视觉和触觉反馈
- **进度指示**: 长时间操作的进度条和状态提示

### 5.3 信息架构

#### 5.3.1 菜单层次结构
```
Git菜单
├── 文件操作
│   ├── Add
│   ├── Remove  
│   ├── Revert
│   └── Diff
├── 分支操作
│   ├── Checkout
│   ├── Merge
│   └── Branch
├── 提交操作
│   ├── Commit
│   ├── Push
│   └── Pull
└── 历史查看
    ├── Log
    ├── Blame
    └── Status
```

#### 5.3.2 对话框信息组织
- **关键信息置顶**: 最重要的信息和操作在最显眼位置
- **逻辑分组**: 相关功能的逻辑分组和视觉分离
- **操作流程**: 按照用户的操作习惯组织界面流程

## 6. 质量保障体系

### 6.1 代码质量标准

#### 6.1.1 编码规范
- **命名约定**: 遵循Qt和现代C++命名约定
- **代码风格**: 统一的代码格式和注释标准
- **架构原则**: SOLID原则和设计模式应用

#### 6.1.2 代码审查
- **同行评审**: 所有代码变更的人工审查
- **自动化检查**: 静态代码分析和格式检查
- **性能评估**: 关键路径的性能测试

### 6.2 测试策略

#### 6.2.1 测试层次
- **单元测试**: 核心逻辑的单元测试覆盖
- **集成测试**: 模块间集成的测试验证
- **UI测试**: 用户界面的自动化测试
- **手工测试**: 关键用户场景的手工验证

#### 6.2.2 测试覆盖
- **功能覆盖**: 所有功能特性的测试覆盖
- **边界条件**: 异常情况和边界条件测试
- **性能测试**: 大型仓库和高并发场景测试

### 6.3 持续改进

#### 6.3.1 用户反馈收集
- **使用数据分析**: 功能使用频率和用户行为分析
- **错误报告**: 自动错误报告和诊断信息收集
- **用户调研**: 定期的用户满意度调查

#### 6.3.2 迭代优化
- **性能监控**: 持续的性能指标监控
- **功能优化**: 基于用户反馈的功能改进
- **技术升级**: 跟进Qt和Git的版本更新

## 7. 部署和维护

### 7.1 安装部署

#### 7.1.1 打包分发
- **Debian包**: 适配深度和Ubuntu系统的deb包
- **AppImage**: 跨发行版的便携式应用包
- **源码编译**: 提供完整的源码编译指南

#### 7.1.2 依赖管理
- **系统依赖**: 最小化系统依赖要求
- **库版本兼容**: 兼容主流Linux发行版的库版本
- **向后兼容**: 支持较老版本的DDE环境

### 7.2 配置管理

#### 7.2.1 用户配置
- **配置文件**: 使用QSettings管理用户配置
- **配置迁移**: 支持配置文件的版本迁移
- **重置选项**: 提供配置重置和恢复默认选项

#### 7.2.2 系统集成
- **桌面集成**: 与DDE桌面环境的深度集成
- **文件关联**: 注册Git相关文件类型关联
- **协议处理**: 支持git://协议的处理

### 7.3 监控和诊断

#### 7.3.1 日志系统
- **分级日志**: DEBUG、INFO、WARNING、ERROR日志级别
- **日志轮转**: 自动的日志文件轮转和清理
- **远程诊断**: 支持远程诊断和问题排查

#### 7.3.2 性能监控
- **资源使用**: 内存和CPU使用情况监控
- **响应时间**: 关键操作的响应时间统计
- **错误率**: 各种错误的发生频率统计

## 8. 未来扩展规划

### 8.1 功能扩展方向

#### 8.1.1 高级Git功能
- **交互式Rebase**: 可视化的交互式变基操作
- **子模块管理**: 完整的Git子模块支持
- **工作树管理**: Git worktree的图形化管理
- **钩子管理**: Git钩子的可视化配置和管理

#### 8.1.2 团队协作功能
- **代码审查**: 集成代码审查流程
- **团队仪表板**: 团队成员的工作状态仪表板
- **通知系统**: Git事件的实时通知
- **权限管理**: 细粒度的操作权限控制

### 8.2 技术演进路线

#### 8.2.1 现代化升级
- **Qt6新特性**: 利用Qt6的最新特性和性能改进
- **C++20标准**: 逐步迁移到C++20标准
- **GPU加速**: 利用GPU加速图形渲染
- **WebAssembly**: 支持WebAssembly的跨平台部署

#### 8.2.2 云服务集成
- **GitLab/GitHub集成**: 深度集成主流Git托管服务
- **CI/CD可视化**: 显示CI/CD管道状态
- **Issue跟踪**: 集成Issue跟踪和项目管理
- **代码统计**: 代码质量和项目健康度统计

### 8.3 生态系统建设

#### 8.3.1 插件架构
- **第三方插件**: 支持第三方开发者扩展功能
- **主题系统**: 支持自定义主题和外观
- **脚本支持**: 支持用户自定义脚本集成
- **API开放**: 提供开放的API接口

#### 8.3.2 社区建设
- **开源社区**: 建立活跃的开源社区
- **文档生态**: 完善的用户和开发者文档
- **培训资源**: Git和工具使用的培训资源
- **最佳实践**: 推广Git工作流最佳实践

---

这个蓝图为DDE文件管理器Git插件的完整开发提供了详细的指导框架，涵盖了从架构设计到用户体验，从技术实现到质量保障的各个方面。它将指导整个开发团队按照统一的愿景和标准进行开发，确保最终产品的高质量和用户满意度。 