# DDE文件管理器Git版本控制插件 - 开发计划

## 版本发布策略

### 版本定义
- **1.0版本**: 最小可行产品(MVP)，核心功能可用
- **2.0版本**: 功能完善版本，用户体验优化
- **3.0版本**: 高级功能版本，企业级特性

---

## 🎯 1.0版本 - 最小可行产品 (MVP)

### TASK001 - 核心基础架构重构
**版本**: 1.0  
**状态**: 计划中  
**优先级**: P0 - 阻塞级

#### 任务描述
重构现有的插件架构，修复已知的路径处理问题，建立稳定的基础架构。

#### 子任务清单
1. **修复Git命令路径处理问题**
   - 修复 buildNormalMenu 中的路径错误
   - 统一使用相对路径处理Git命令
   - 实现智能路径转换工具函数

2. **重构GitOperationDialog**
   - 修复进度显示和实时输出更新
   - 改进错误处理和用户反馈机制
   - 添加操作取消和超时处理

3. **优化缓存系统**
   - 改进Global::Cache的线程安全性
   - 添加缓存失效和自动刷新机制
   - 实现增量状态更新

#### 验收标准
- [x] 所有Git基本操作(add/remove/revert)正常工作
- [x] Git命令使用正确的相对路径
- [x] 操作对话框显示完整的命令输出
- [x] 状态缓存在Git操作后自动更新
- [x] 无内存泄漏和线程竞争问题

#### 注意事项
- 确保向后兼容性，不破坏现有功能
- 所有路径处理必须考虑中文路径和特殊字符
- Git命令失败时提供用户友好的错误信息
- 性能优化要兼顾内存使用和响应速度

#### AI编程助手提示词
```
你是一个资深的C++/Qt开发专家，专精dfm-extension框架开发。当前任务是重构DDE文件管理器Git插件的核心架构。

**上下文**:
- 现有代码存在Git命令路径处理错误，使用绝对路径而非相对路径
- GitOperationDialog的实时输出显示不完整
- 缓存系统存在线程安全问题

**技术要求**:
- 使用现代C++17标准
- 遵循Qt最佳实践和信号槽机制
- 确保线程安全和异常安全
- 添加完整的英文日志记录

**具体任务**:
1. 分析现有的gitmenuplugin.cpp中的路径处理问题
2. 重构handleGitAdd/Remove/Revert函数，使用QDir::relativeFilePath
3. 改进GitOperationDialog的QProcess输出处理
4. 优化Global::Cache的线程安全实现

**代码风格**:
- 类名使用PascalCase
- 函数名使用camelCase  
- 成员变量使用m_前缀
- 添加详细的Doxygen注释
- 错误处理使用qWarning/qCritical日志

请提供完整的实现代码，包括头文件声明和源文件实现。
```

---

### TASK002 - Git Log界面彻底重构
**版本**: 1.0  
**状态**: 计划中  
**优先级**: P0 - 阻塞级

#### 任务描述
完全重构GitLogDialog，实现GitKraken风格的三栏布局，解决当前分页加载不智能的问题。

#### 子任务清单
1. **设计新的三栏布局**
   - 左侧：提交列表(支持图形化分支显示)
   - 右上：提交详情显示区域
   - 右下：文件差异显示区域

2. **实现智能无限滚动**
   - 检测滚动到底部自动加载更多
   - 移除手动"Load More"按钮
   - 实现虚拟滚动优化性能

3. **增强搜索和过滤功能**
   - 实时搜索提交消息、作者、哈希
   - 分支过滤和时间范围过滤
   - 搜索结果高亮显示

4. **文件差异语法高亮**
   - 使用QSyntaxHighlighter实现代码高亮
   - 支持多种编程语言的语法着色
   - 差异行的颜色区分(添加/删除/修改)

#### 验收标准
- [ ] 三栏布局响应式设计，支持拖拽调整大小
- [ ] 滚动到底部自动加载更多提交，无需手动点击
- [ ] 搜索功能实时响应，支持正则表达式
- [ ] 文件差异有语法高亮，代码可读性高
- [ ] 支持大型仓库(10000+提交)的流畅浏览
- [ ] 内存使用控制在合理范围内

#### 注意事项
- 虚拟滚动实现要考虑Qt的MVC架构
- 语法高亮需要检测文件类型自动应用规则
- 大仓库的性能优化是关键，避免一次性加载过多数据
- UI响应性优于功能完整性，确保界面不卡顿

#### AI编程助手提示词
```
你是一个Qt界面开发专家，精通QSplitter、QTreeWidget、QTextEdit等控件的高级用法。当前任务是重构Git Log查看器，实现GitKraken风格的现代化界面。

**设计目标**:
- 参考GitKraken的三栏布局设计
- 实现智能的无限滚动加载
- 提供流畅的用户体验，特别是大型仓库

**技术挑战**:
- 虚拟滚动的实现(处理大量提交记录)
- QSyntaxHighlighter的自定义语法规则
- 多线程的Git命令执行和UI更新

**布局要求**:
```
┌─────────────────────────────────────┐
│ [工具栏: 搜索|分支选择|刷新]        │
├──────────────┬──────────────────────┤
│   提交列表   │   提交详情           │
│ ┌──────────┐ │ ┌──────────────────┐ │
│ │● feat:   │ │ │哈希: abc123...   │ │
│ │├─● fix:  │ │ │作者: John Doe    │ │
│ │└─● docs: │ │ │时间: 2024-01-01  │ │
│ │          │ │ └──────────────────┘ │
│ └──────────┘ │ ┌──────────────────┐ │
│              │ │   文件差异       │ │
│              │ │ +++ src/main.cpp │ │
│              │ │ --- src/main.cpp │ │
│              │ │ @@ -1,3 +1,5 @@  │ │
│              │ └──────────────────┘ │
└──────────────┴──────────────────────┘
```

**关键实现点**:
1. 使用QSplitter实现可调整的三栏布局
2. QTreeWidget的虚拟模式处理大数据集
3. QTextEdit的QSyntaxHighlighter实现diff语法高亮
4. QScrollBar的滚动事件检测实现无限加载

**性能要求**:
- 初次加载不超过100条提交
- 滚动加载每次增加50条提交
- 内存使用不超过200MB(即使是大型仓库)
- UI响应时间不超过100ms

请提供完整的GitLogDialog重构代码，包括.h和.cpp文件。
```

---

### TASK003 - 智能右键菜单系统
**版本**: 1.0  
**状态**: 计划中  
**优先级**: P1 - 重要

#### 任务描述
重构右键菜单系统，实现智能的上下文感知菜单，根据文件状态动态调整可用操作。

#### 子任务清单
1. **菜单项状态智能检测**
   - 根据文件Git状态启用/禁用菜单项
   - 添加菜单项工具提示说明适用条件
   - 实现多文件选择时的智能菜单合并

2. **扩展菜单功能**
   - 添加Git Diff操作
   - 添加Git Blame功能
   - 添加Git Status概览
   - 实现文件历史快速访问

3. **菜单图标和视觉优化**
   - 使用一致的图标主题
   - 添加状态指示器(如当前分支显示)
   - 改进菜单项的分组和排序

#### 验收标准
- [ ] 菜单项根据文件状态智能启用/禁用
- [ ] 工具提示清楚说明每个操作的适用条件
- [ ] 多文件选择时菜单项合理合并
- [ ] 所有新增功能正常工作
- [ ] 菜单加载速度快于200ms

#### AI编程助手提示词
```
你是dfm-extension菜单系统的专家，熟悉DFMExtMenuPlugin的工作机制。任务是创建智能的Git右键菜单系统。

**智能菜单需求**:
- 根据文件的Git状态动态显示可用操作
- 多文件选择时智能合并菜单选项
- 提供清晰的视觉反馈和操作提示

**文件状态到菜单项的映射**:
- UnversionedVersion: 显示"Git Add"
- LocallyModifiedUnstagedVersion: 显示"Git Add", "Git Revert", "Git Diff"
- LocallyModifiedVersion: 显示"Git Remove", "Git Revert", "Git Diff"
- NormalVersion: 显示"Git Remove", "Git Log", "Git Blame"
- ConflictingVersion: 显示"Git Revert", "Git Merge Tool"

**技术实现要点**:
1. 使用Utils::getFileGitStatus()获取文件状态
2. 动态创建菜单项并设置enabled状态
3. 添加工具提示(setToolTip)说明操作条件
4. 使用图标资源增强视觉效果

**多文件处理逻辑**:
- 选择的所有文件都是同一状态: 显示该状态的所有操作
- 选择的文件状态混合: 只显示通用操作(如批量添加)
- 超过10个文件: 只显示批量操作

请重构GitMenuPlugin类，实现智能菜单系统。
```

---

### TASK004 - 基础操作对话框完善
**版本**: 1.0  
**状态**: 计划中  
**优先级**: P1 - 重要

#### 任务描述
完善现有的Git操作对话框，改进用户体验和错误处理。

#### 子任务清单
1. **GitCommitDialog改进**
   - 实现暂存区和工作区文件的分别显示
   - 添加提交消息模板支持
   - 实现文件差异预览功能

2. **GitCheckoutDialog增强**
   - 显示分支的详细信息(最后提交时间、作者)
   - 添加新建分支时的基于分支选择
   - 实现分支状态可视化(当前、已合并、远程)

3. **统一错误处理**
   - 标准化错误消息格式
   - 添加操作失败后的恢复建议
   - 实现错误日志的详细记录

#### 验收标准
- [ ] 提交对话框支持分别查看暂存区和工作区文件
- [ ] 分支切换对话框显示丰富的分支信息
- [ ] 错误处理友好且提供有用的解决建议
- [ ] 所有对话框支持键盘导航

#### AI编程助手提示词
```
你是Qt对话框设计专家，擅长创建用户友好的界面。任务是改进Git操作对话框的用户体验。

**GitCommitDialog改进要求**:
```
┌─────────────────────────────────┐
│ Git Commit                   × │
├─────────────────────────────────┤
│ 提交消息:                       │
│ ┌─────────────────────────────┐ │
│ │ feat: 新功能描述            │ │
│ ├─────────────────────────────┤ │
│ │ 详细描述...                 │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│ 暂存区文件 (3) [全选][反选]    │
│ ☑ src/main.cpp      [M] 修改   │
│ ☑ src/utils.h       [A] 新增   │
├─────────────────────────────────┤
│ 工作区文件 (2) [添加到暂存区]  │
│ ☐ test/test.cpp     [M] 修改   │
│ ☐ docs/README.md    [M] 修改   │
├─────────────────────────────────┤
│              [取消] [提交]     │
└─────────────────────────────────┘
```

**关键功能**:
1. 使用QListWidget分别显示暂存区和工作区文件
2. 双击文件显示差异预览对话框
3. 提交消息支持模板(存储在用户配置中)
4. 实现Conventional Commits规范验证

**GitCheckoutDialog改进要求**:
- 显示分支的最后提交信息和时间
- 区分本地分支、远程分支、已合并分支
- 新建分支时支持选择基于的分支
- 添加分支删除和重命名功能

**错误处理标准**:
- 使用QMessageBox显示友好的错误信息
- 提供"复制错误信息"按钮便于报告问题
- 记录详细的错误日志到qDebug()
- 对常见错误提供解决建议

请提供改进后的对话框实现代码。
```

---

## 🚀 2.0版本 - 功能完善版本

### TASK005 - 高级Git Log功能
**版本**: 2.0  
**状态**: 计划中  
**优先级**: P1 - 重要

#### 任务描述
在1.0版本的基础上，添加高级的Git Log功能，包括图形化分支显示、文件级历史等。

#### 子任务清单
1. **图形化分支视图**
   - 实现ASCII艺术风格的分支图形显示
   - 支持自定义绘制的分支线条
   - 添加分支合并路径的可视化

2. **文件级历史追踪**
   - 实现单个文件的完整修改历史
   - 支持文件重命名的历史追踪
   - 添加文件修改热力图显示

3. **高级搜索功能**
   - 支持正则表达式搜索
   - 按时间范围、作者、文件路径过滤
   - 保存和管理搜索历史

#### AI编程助手提示词
```
你是Git可视化专家，熟悉复杂的Git历史图形化显示。任务是为Git Log添加高级可视化功能。

**图形化分支显示要求**:
- 使用自定义的QPainter绘制分支线条
- 支持多种颜色区分不同分支
- 实现分支合并点的特殊标记
- 支持折叠/展开分支的显示

**技术实现**:
1. 继承QStyledItemDelegate自定义绘制
2. 解析git log --graph输出构建分支结构
3. 使用QPainter绘制Bezier曲线表示分支
4. 实现鼠标交互(悬停显示分支信息)

**性能考虑**:
- 大型仓库的分支图绘制优化
- 使用缓存避免重复计算
- 实现视口裁剪减少绘制开销

请提供图形化分支显示的完整实现。
```

---

### TASK006 - Git Stash管理器
**版本**: 2.0  
**状态**: 计划中  
**优先级**: P2 - 一般

#### 任务描述
创建专门的Git Stash管理界面，提供完整的stash生命周期管理。

#### 子任务清单
1. **Stash列表管理**
   - 显示所有stash条目及其描述
   - 支持stash的创建、应用、删除
   - 实现stash的重命名和编辑描述

2. **Stash内容预览**
   - 显示stash包含的文件列表
   - 预览每个文件的差异内容
   - 支持部分文件的选择性应用

3. **高级Stash操作**
   - 支持stash的分支创建
   - 实现stash的合并和冲突解决
   - 添加stash的导出和导入功能

#### AI编程助手提示词
```
你是Git工作流专家，深度理解Git stash的使用场景和最佳实践。任务是创建用户友好的Stash管理界面。

**Stash管理器界面设计**:
```
┌─────────────────────────────────────────┐
│ Git Stash Manager                    × │
├─────────────────┬───────────────────────┤
│ Stash列表       │ Stash内容预览         │
│ ┌─────────────┐ │ ┌───────────────────┐ │
│ │ stash@{0}   │ │ │ src/main.cpp  [M] │ │
│ │ 修复登录Bug │ │ │ test/auth.cpp [A] │ │
│ │ 2小时前     │ │ │                   │ │
│ ├─────────────┤ │ │ +++ src/main.cpp  │ │
│ │ stash@{1}   │ │ │ @@ -10,3 +10,5 @@ │ │
│ │ 临时保存   │ │ │ + new code here   │ │
│ │ 1天前       │ │ │                   │ │
│ └─────────────┘ │ └───────────────────┘ │
├─────────────────┴───────────────────────┤
│ [新建Stash] [应用] [删除] [创建分支]   │
└─────────────────────────────────────────┘
```

**核心功能**:
1. 解析`git stash list`输出显示stash列表
2. 使用`git stash show -p`显示stash内容差异
3. 实现选择性stash应用(git stash apply --index)
4. 支持从stash创建新分支(git stash branch)

**用户体验要求**:
- 双击stash条目快速应用
- 右键菜单提供完整操作选项
- 拖拽支持stash的重新排序
- 提供stash冲突的智能解决建议

请实现完整的GitStashDialog类。
```

---

### TASK007 - Git配置管理界面
**版本**: 2.0  
**状态**: 计划中  
**优先级**: P2 - 一般

#### 任务描述
创建图形化的Git配置管理界面，让用户可以方便地管理Git设置。

#### 子任务清单
1. **用户身份配置**
   - 设置用户名和邮箱
   - 配置GPG签名密钥
   - 管理多个身份配置

2. **仓库配置管理**
   - 远程仓库的添加、编辑、删除
   - 分支跟踪配置
   - 忽略文件(.gitignore)的可视化编辑

3. **全局设置管理**
   - Git全局配置的图形化编辑
   - 别名(alias)的管理
   - 钩子脚本的配置和编辑

#### AI编程助手提示词
```
你是Git配置专家，熟悉Git的各种配置选项和最佳实践。任务是创建直观的Git配置管理界面。

**配置管理界面设计**:
使用QTabWidget组织不同类型的配置:
1. 用户身份标签页
2. 仓库设置标签页  
3. 全局配置标签页
4. 高级选项标签页

**关键技术点**:
1. 使用`git config --list`读取现有配置
2. 使用`git config --global/--local`设置配置
3. 解析和编辑.gitignore文件
4. 验证邮箱格式和GPG密钥的有效性

**用户体验设计**:
- 配置项的分组和层次化显示
- 实时验证配置的有效性
- 提供常用配置的快速设置模板
- 支持配置的导入和导出

请实现GitConfigDialog类，提供完整的Git配置管理功能。
```

---

## 🌟 3.0版本 - 高级功能版本

### TASK008 - Git合并冲突解决器
**版本**: 3.0  
**状态**: 计划中  
**优先级**: P2 - 一般

#### 任务描述
实现专业级的三向合并冲突解决工具，类似于KDiff3或Meld的功能。

#### 子任务清单
1. **三向合并视图**
   - 左侧：当前分支(ours)
   - 中间：合并结果
   - 右侧：目标分支(theirs)
   - 底部：共同祖先(base)

2. **智能冲突解决**
   - 自动标识冲突区域
   - 提供快速解决选项(选择左侧/右侧/手动编辑)
   - 支持逐行的冲突解决

3. **高级编辑功能**
   - 语法高亮和代码折叠
   - 行号对齐和同步滚动
   - 撤销/重做和搜索替换

#### AI编程助手提示词
```
你是代码合并工具专家，熟悉三向合并算法和冲突解决UI设计。任务是创建专业级的Git合并冲突解决器。

**三向合并界面设计**:
```
┌──────────────────────────────────────────────────────┐
│ Git Merge Conflict Resolver                       × │
├─────────────────┬──────────────────┬─────────────────┤
│ 当前分支(Ours)  │   合并结果       │ 目标分支(Theirs)│
│ ┌─────────────┐ │ ┌──────────────┐ │ ┌─────────────┐ │
│ │ function()  │ │ │ function()   │ │ │ function()  │ │
│ │ {           │ │ │ {            │ │ │ {           │ │
│ │   oldCode   │ │ │ <<<<<<< HEAD │ │ │   newCode   │ │
│ │             │ │ │   oldCode    │ │ │             │ │
│ │             │ │ │ =======      │ │ │             │ │
│ │             │ │ │   newCode    │ │ │             │ │
│ │             │ │ │ >>>>>>> br   │ │ │             │ │
│ │ }           │ │ │ }            │ │ │ }           │ │
│ └─────────────┘ │ └──────────────┘ │ └─────────────┘ │
├─────────────────┴──────────────────┴─────────────────┤
│ [使用左侧] [手动编辑] [使用右侧] [下一个冲突] [保存] │
└──────────────────────────────────────────────────────┘
```

**技术实现要点**:
1. 解析git merge冲突标记(<<<<<<<, =======, >>>>>>>)
2. 使用QTextEdit的自定义语法高亮器标记冲突区域
3. 实现同步滚动和行号对齐
4. 提供冲突的快速解决按钮

**核心算法**:
- 解析冲突文件的三向差异
- 实现diff3算法的可视化
- 支持二进制文件的冲突处理
- 提供冲突统计和进度显示

请实现GitMergeDialog类，创建专业的冲突解决界面。
```

---

### TASK009 - Git工作流可视化
**版本**: 3.0  
**状态**: 计划中  
**优先级**: P3 - 可选

#### 任务描述
实现Git工作流的可视化显示，包括Gitflow、GitHub Flow等标准工作流的图形化表示。

#### 子任务清单
1. **工作流图形化**
   - 绘制分支模型图表
   - 显示工作流状态和进度
   - 提供工作流操作的快捷入口

2. **Gitflow集成**
   - 支持feature/hotfix/release分支的创建和管理
   - 自动化版本号管理
   - 集成语义化版本控制

3. **团队协作视图**
   - 显示团队成员的工作状态
   - 分支权限和代码审查流程
   - 集成CI/CD状态显示

#### AI编程助手提示词
```
你是DevOps工作流专家，深度理解Git工作流模式和团队协作最佳实践。任务是创建Git工作流的可视化管理工具。

**工作流可视化需求**:
- 支持主流工作流模式(Gitflow, GitHub Flow, GitLab Flow)
- 实时显示分支状态和合并进度
- 提供工作流操作的图形化界面

**Gitflow可视化示例**:
```
┌─────────────────────────────────────────┐
│ Gitflow Workflow Visualizer         × │
├─────────────────────────────────────────┤
│ master    ●─────●─────●─────●── v1.0.0   │
│             ╲       ╱                   │
│ release      ●─────●        v1.0.0-rc1  │
│                ╲   ╱                    │
│ develop   ●─────●─●─●─────●              │
│           ╱         ╲     ╲             │
│ feature  ●───────────●     ●            │
│          login-ui          settings     │
├─────────────────────────────────────────┤
│ 当前状态: 开发阶段                      │
│ 活跃分支: 2个feature, 1个release        │
│ 下个里程碑: v1.0.0 (预计3天后)          │
├─────────────────────────────────────────┤
│ [新建Feature] [开始Release] [查看状态]  │
└─────────────────────────────────────────┘
```

**技术实现**:
1. 使用QPainter自定义绘制工作流图表
2. 解析Git分支信息构建工作流状态
3. 集成git-flow命令行工具
4. 实现交互式的工作流操作

请实现GitWorkflowDialog类，提供工作流可视化管理功能。
```

---

### TASK010 - 性能优化和企业级特性
**版本**: 3.0  
**状态**: 计划中  
**优先级**: P2 - 一般

#### 任务描述
针对大型企业环境进行性能优化，添加企业级功能如权限管理、审计日志等。

#### 子任务清单
1. **大型仓库性能优化**
   - 实现Git对象的增量加载
   - 优化大文件的处理和显示
   - 添加后台预加载和缓存策略

2. **企业级安全特性**
   - 集成LDAP/AD用户认证
   - 实现分支保护和操作权限控制
   - 添加操作审计日志和合规报告

3. **监控和诊断**
   - 性能指标的实时监控
   - 内存使用和资源消耗分析
   - 自动错误报告和诊断信息收集

#### AI编程助手提示词
```
你是系统性能优化专家，精通C++内存管理和Qt应用的性能调优。任务是优化Git插件在企业环境中的性能和稳定性。

**性能优化重点**:
1. 大型仓库(100GB+)的处理优化
2. 多用户并发访问的资源管理
3. 长时间运行的内存稳定性
4. 网络IO和磁盘IO的优化

**企业级特性需求**:
- 集成企业身份认证系统
- 实现细粒度的权限控制
- 提供详细的操作审计日志
- 支持企业级的配置管理

**技术实现方案**:
1. 使用QCache和智能指针优化内存管理
2. 实现多线程的任务队列系统
3. 集成OpenLDAP或Active Directory
4. 使用SQLite存储审计日志和配置

**监控指标**:
- 内存使用峰值和平均值
- Git命令执行时间统计
- UI响应时间监控
- 错误率和崩溃频率

请提供企业级优化的实现方案和代码。
```

---

## 📋 任务状态说明

### 状态定义
- **计划中**: 任务已规划，待开始执行
- **设计中**: 正在进行详细设计和技术方案评估
- **开发中**: 正在编写代码实现
- **测试中**: 功能实现完成，正在进行测试验证
- **完成**: 任务完成并通过验收标准

### 优先级定义
- **P0 - 阻塞级**: 阻塞其他任务的关键功能
- **P1 - 重要**: 影响用户体验的重要功能
- **P2 - 一般**: 改善功能的一般特性
- **P3 - 可选**: 锦上添花的可选功能

---

## 🎯 里程碑计划

### 1.0版本里程碑
**目标发布时间**: 开发开始后4-6周  
**核心特性**: 基础Git操作稳定可用
**验收标准**: 
- 所有TASK001-004完成并通过测试
- 性能测试通过(支持1000+文件的仓库)
- 用户可以完成基本的Git工作流

### 2.0版本里程碑
**目标发布时间**: 1.0版本后4-6周  
**核心特性**: 高级功能和用户体验优化
**验收标准**:
- 所有TASK005-007完成并通过测试
- 用户满意度调查达到80%以上
- 支持复杂的Git工作流场景

### 3.0版本里程碑
**目标发布时间**: 2.0版本后6-8周  
**核心特性**: 企业级功能和性能优化
**验收标准**:
- 所有TASK008-010完成并通过测试
- 支持企业级部署和管理
- 性能满足大型团队使用需求

---

这个开发计划为项目提供了清晰的路线图，每个任务都有详细的子任务、验收标准和专门的AI编程助手提示词，确保开发过程的高效和质量。 